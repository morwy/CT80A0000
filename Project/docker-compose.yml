# --------------------------------------------------------------------------------------------------
#
# Docker and cloud technologies are allowed.
#
# Databases based on the number of people in the group: 
#   3 people = 3 databases, 
#   4 people = 4 databases, 
#   5 people = 5 databases
#
# --------------------------------------------------------------------------------------------------
networks:
  galera-net:
    driver: bridge

services:
  radar1:
    image: mariadb:10.11
    container_name: radar1
    hostname: radar1
    networks:
      - galera-net
    ports:
      - "33061:3306"   # MySQL client
      - "4567:4567"    # Galera replication
      - "4568:4568"    # IST
      - "4444:4444"    # SST
    environment:
      MYSQL_ROOT_PASSWORD: SuperSecureMilitaryPassword
      MYSQL_DATABASE: radar_db
      MYSQL_USER: officer
      MYSQL_PASSWORD: officerPassword
      MARIADB_GALERA_CLUSTER_NAME: galera_cluster
      MARIADB_GALERA_MARIABACKUP_USER: backup
      MARIADB_GALERA_MARIABACKUP_PASSWORD: backup
      MARIADB_GALERA_FORCE_SST: "ON"
    command: ["--wsrep-new-cluster"]
    volumes:
      - ./db/radar1:/var/lib/mysql
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-uroot", "-pSuperSecureMilitaryPassword"]
      interval: 10s
      timeout: 5s
      retries: 10

  radar2:
    image: mariadb:10.11
    container_name: radar2
    hostname: radar2
    networks:
      - galera-net
    ports:
      - "33062:3306"
    environment:
      MYSQL_ROOT_PASSWORD: SuperSecureMilitaryPassword
      MARIADB_GALERA_CLUSTER_NAME: galera_cluster
      MARIADB_GALERA_CLUSTER_JOIN: radar1
      MARIADB_GALERA_MARIABACKUP_USER: backup
      MARIADB_GALERA_MARIABACKUP_PASSWORD: backup
    depends_on:
      - radar1
    volumes:
      - ./db/radar2:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-uroot", "-pSuperSecureMilitaryPassword"]
      interval: 10s
      timeout: 5s
      retries: 10

  radar3:
    image: mariadb:10.11
    container_name: radar3
    hostname: radar3
    networks:
      - galera-net
    ports:
      - "33063:3306"
    environment:
      MYSQL_ROOT_PASSWORD: SuperSecureMilitaryPassword
      MARIADB_GALERA_CLUSTER_NAME: galera_cluster
      MARIADB_GALERA_CLUSTER_JOIN: radar1
      MARIADB_GALERA_MARIABACKUP_USER: backup
      MARIADB_GALERA_MARIABACKUP_PASSWORD: backup
    depends_on:
      - radar1
    volumes:
      - ./db/radar3:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-uroot", "-pSuperSecureMilitaryPassword"]
      interval: 10s
      timeout: 5s
      retries: 10